{% extends "layout.html" %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ - Workers System{% endblock %}

{% block page_content %}
<div class="page-header">
    <div>
        <h1 class="page-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
        <p class="page-subtitle">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã</p>
    </div>
    <button onclick="checkHealth()" class="button button-primary" id="checkHealthBtn">
        <span>üîÑ</span>
        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
    </button>
</div>

<!-- Health Status -->
<div class="card">
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">
        <span style="font-size: 1.5rem;">‚öôÔ∏è</span>
        <h2 style="margin: 0; font-size: 1.25rem; font-weight: bold; color: #1f2937;">
            –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
        </h2>
    </div>

    <div id="healthStatus">
        {% if health %}
        <div style="display: flex; flex-direction: column; gap: 16px;">
            <!-- Backend Status -->
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background-color: #f9fafb; border-radius: 6px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 1.25rem;">üñ•Ô∏è</span>
                    <div>
                        <div style="font-weight: 500; color: #1f2937;">Backend API</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">FastAPI —Å–µ—Ä–≤–µ—Ä</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 1.25rem;">{{ '‚úÖ' if health.ok else '‚ùå' }}</span>
                    <span style="font-weight: 500; color: {{ '#059669' if health.ok else '#dc2626' }};">
                        {{ '–†–∞–±–æ—Ç–∞–µ—Ç' if health.ok else '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ' }}
                    </span>
                </div>
            </div>

            <!-- Database Status -->
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background-color: #f9fafb; border-radius: 6px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 1.25rem;">üóÑÔ∏è</span>
                    <div>
                        <div style="font-weight: 500; color: #1f2937;">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">MongoDB</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 1.25rem;">{{ '‚úÖ' if health.db_connected else '‚ùå' }}</span>
                    <span style="font-weight: 500; color: {{ '#059669' if health.db_connected else '#dc2626' }};">
                        {{ '–†–∞–±–æ—Ç–∞–µ—Ç' if health.db_connected else '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ' }}
                    </span>
                </div>
            </div>

            <!-- Bot Status -->
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background-color: #f9fafb; border-radius: 6px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 1.25rem;">ü§ñ</span>
                    <div>
                        <div style="font-weight: 500; color: #1f2937;">Telegram Bot</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">@moverspb_bot</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 1.25rem;">‚úÖ</span>
                    <span style="font-weight: 500; color: #059669;">–ê–∫—Ç–∏–≤–µ–Ω</span>
                </div>
            </div>

            <!-- System Info -->
            <div style="margin-top: 24px; padding: 16px; background-color: #f9fafb; border-radius: 6px;">
                <h3 style="margin: 0 0 8px 0; font-weight: 500; color: #1f2937;">
                    –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ
                </h3>
                <div style="font-size: 0.875rem; color: #6b7280; line-height: 1.5;">
                    <div>–°–µ—Ä–≤–∏—Å: {{ health.service }}</div>
                    <div>–í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏: {{ health.time | format_datetime }}</div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="loading">
            <div class="spinner"></div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Configuration -->
<div class="card">
    <h2 style="margin: 0 0 24px 0; font-size: 1.25rem; font-weight: bold; color: #1f2937;">
        –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    </h2>
    
    <div style="display: flex; flex-direction: column; gap: 24px;">
        <!-- Bot Settings -->
        <div>
            <h3 style="margin: 0 0 12px 0; font-size: 1rem; font-weight: 500; color: #1f2937;">
                –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞
            </h3>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background-color: #f9fafb; border-radius: 6px;">
                    <div>
                        <div style="font-weight: 500; color: #1f2937;">–¢–æ–∫–µ–Ω –±–æ—Ç–∞</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω Telegram</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span>‚úÖ</span>
                        <span style="font-size: 0.875rem; color: #059669;">–ù–∞—Å—Ç—Ä–æ–µ–Ω</span>
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background-color: #f9fafb; border-radius: 6px;">
                    <div>
                        <div style="font-weight: 500; color: #1f2937;">Webhook</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">–†–µ–∂–∏–º –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span>ü§ñ</span>
                        <span style="font-size: 0.875rem; color: #3b82f6;">Polling</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Settings -->
        <div>
            <h3 style="margin: 0 0 12px 0; font-size: 1rem; font-weight: 500; color: #1f2937;">
                –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API
            </h3>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background-color: #f9fafb; border-radius: 6px;">
                    <div>
                        <div style="font-weight: 500; color: #1f2937;">CORS</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">–†–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è –∫—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span>‚úÖ</span>
                        <span style="font-size: 0.875rem; color: #059669;">–í–∫–ª—é—á–µ–Ω</span>
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background-color: #f9fafb; border-radius: 6px;">
                    <div>
                        <div style="font-weight: 500; color: #1f2937;">–ê–≤—Ç–æ–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">Swagger UI –¥–ª—è API</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span>‚úÖ</span>
                        <span style="font-size: 0.875rem; color: #059669;">–î–æ—Å—Ç—É–ø–Ω–∞</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Settings -->
        <div>
            <h3 style="margin: 0 0 12px 0; font-size: 1rem; font-weight: 500; color: #1f2937;">
                –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            </h3>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background-color: #f9fafb; border-radius: 6px;">
                    <div>
                        <div style="font-weight: 500; color: #1f2937;">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">MongoDB async driver</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        {% if health and health.db_connected %}
                        <span>‚úÖ</span>
                        <span style="font-size: 0.875rem; color: #059669;">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
                        {% else %}
                        <span>‚ùå</span>
                        <span style="font-size: 0.875rem; color: #dc2626;">–û—Ç–∫–ª—é—á–µ–Ω–æ</span>
                        {% endif %}
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background-color: #f9fafb; border-radius: 6px;">
                    <div>
                        <div style="font-weight: 500; color: #1f2937;">–ò–Ω–¥–µ–∫—Å—ã</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span>‚úÖ</span>
                        <span style="font-size: 0.875rem; color: #059669;">–ù–∞—Å—Ç—Ä–æ–µ–Ω—ã</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Actions -->
<div class="card">
    <h2 style="margin: 0 0 24px 0; font-size: 1.25rem; font-weight: bold; color: #1f2937;">
        –î–µ–π—Å—Ç–≤–∏—è
    </h2>
    
    <div style="display: flex; flex-direction: column; gap: 16px;">
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; border: 1px solid #e5e7eb; border-radius: 6px;">
            <div>
                <div style="font-weight: 500; color: #1f2937;">–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã</div>
                <div style="font-size: 0.875rem; color: #6b7280;">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã</div>
            </div>
            <button onclick="restartSystem()" class="button button-warning">
                –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
            </button>
        </div>
        
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; border: 1px solid #e5e7eb; border-radius: 6px;">
            <div>
                <div style="font-weight: 500; color: #1f2937;">–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤</div>
                <div style="font-size: 0.875rem; color: #6b7280;">–°–∏—Å—Ç–µ–º–Ω—ã–µ –∂—É—Ä–Ω–∞–ª—ã —Å–æ–±—ã—Ç–∏–π</div>
            </div>
            <button onclick="viewLogs()" style="padding: 8px 16px; background-color: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500;">
                –û—Ç–∫—Ä—ã—Ç—å –ª–æ–≥–∏
            </button>
        </div>
    </div>
</div>

<script>
async function checkHealth() {
    const btn = document.getElementById('checkHealthBtn');
    const statusContainer = document.getElementById('healthStatus');
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner" style="width: 16px; height: 16px;"></span> –ü—Ä–æ–≤–µ—Ä–∫–∞...';
        
        showLoading(statusContainer);
        
        const health = await api.get('/health');
        location.reload(); // Reload to update health status
        
    } catch (error) {
        statusContainer.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background-color: #fef2f2; border: 1px solid #fecaca; border-radius: 6px;">
                <span style="font-size: 1.25rem;">‚ö†Ô∏è</span>
                <span style="color: #dc2626;">–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã: ${error.message}</span>
            </div>
        `;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>üîÑ</span> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
    }
}

function restartSystem() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏—Å—Ç–µ–º—É?')) {
        showSuccess('–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã... –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.');
        // In real implementation, this would call restart API
        setTimeout(() => location.reload(), 3000);
    }
}

function viewLogs() {
    window.open('/api/logs', '_blank');
}
</script>
{% endblock %}