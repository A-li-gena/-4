{% extends "base.html" %}

{% block title %}–†–∞–±–æ—á–∏–µ –∑–∞–¥–∞–Ω–∏—è - Workers System{% endblock %}

{% block content %}
<div class="webapp-container">
    <!-- Header -->
    <div class="webapp-header">
        <h1>–†–∞–±–æ—á–∏–µ –∑–∞–¥–∞–Ω–∏—è</h1>
        
        <!-- Tabs -->
        <div class="tabs-container">
            <a href="?user_id={{ user_id }}&tab=tasks" class="tab-button {% if active_tab == 'tasks' %}active{% endif %}">
                üìã –ó–∞–¥–∞–Ω–∏—è
            </a>
            <a href="?user_id={{ user_id }}&tab=reminders" class="tab-button {% if active_tab == 'reminders' %}active{% endif %}">
                ‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
            </a>
        </div>
    </div>

    <!-- Content -->
    <div class="content-container">
        {% if active_tab == 'tasks' %}
        <!-- Tasks Tab -->
        <div class="section-header">
            <h2 class="section-title">
                –ú–æ–∏ –∑–∞–¥–∞–Ω–∏—è ({{ tasks|length }})
            </h2>
            <button onclick="showModal('createTaskModal')" class="add-button">
                +
            </button>
        </div>

        {% if tasks %}
        {% for task in tasks %}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">{{ task.title }}</h3>
                <span class="status-badge {% if task.status == 'published' %}status-published{% elif task.status == 'pending' %}status-pending{% elif task.status == 'completed' %}status-completed{% else %}status-default{% endif %}">
                    {% if task.status == 'published' %}–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ{% elif task.status == 'pending' %}–ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏{% elif task.status == 'completed' %}–í—ã–ø–æ–ª–Ω–µ–Ω–æ{% else %}–ß–µ—Ä–Ω–æ–≤–∏–∫{% endif %}
                </span>
            </div>
            
            <div class="card-details">
                <div class="card-detail">
                    <span>üìç</span>
                    <span>{{ task.location }}</span>
                </div>
                
                <div class="card-detail">
                    <span>üìÖ</span>
                    <span>{{ task.start_datetime | format_datetime }}</span>
                </div>
                
                <div class="card-detail">
                    <span>‚è∞</span>
                    <span>{{ task.duration_hours }} —á–∞—Å–æ–≤</span>
                </div>
                
                <div class="card-detail">
                    <span>üí∞</span>
                    <span>{{ task.client_price | format_currency }}</span>
                </div>
                
                {% if task.requirements %}
                <div class="card-detail">
                    <span>üë•</span>
                    <span>
                        {% for req in task.requirements %}
                        {{ req.count }} 
                        {% if req.worker_type == 'loader' %}–≥—Ä—É–∑—á–∏–∫{% elif req.worker_type == 'driver' %}–≤–æ–¥–∏—Ç–µ–ª—å{% elif req.worker_type == 'rigger' %}—Ç–∞–∫–µ–ª–∞–∂–Ω–∏–∫{% elif req.worker_type == 'cleaner' %}—É–±–æ—Ä—â–∏–∫{% else %}—Ä–∞–∑–Ω–æ—Ä–∞–±–æ—á–∏–π{% endif %}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </span>
                </div>
                {% endif %}
            </div>
            
            <div class="card-description">
                <p>{{ task.description }}</p>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <p class="empty-state-text">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞–Ω–∏–π</p>
            <button onclick="showModal('createTaskModal')" class="button button-primary">
                –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ
            </button>
        </div>
        {% endif %}

        {% elif active_tab == 'reminders' %}
        <!-- Reminders Tab -->
        <div class="section-header">
            <h2 class="section-title">
                –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è ({{ reminders|length }})
            </h2>
            <button onclick="showModal('createReminderModal')" class="add-button">
                +
            </button>
        </div>

        {% if reminders %}
        {% for reminder in reminders %}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">{{ reminder.title }}</h3>
                <span class="status-badge {% if reminder.is_sent %}status-default{% else %}status-published{% endif %}">
                    {% if reminder.is_sent %}–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ{% else %}–ê–∫—Ç–∏–≤–Ω–æ{% endif %}
                </span>
            </div>
            
            <div class="card-details">
                <div class="card-detail">
                    <span>‚è∞</span>
                    <span>{{ reminder.remind_at | format_datetime }}</span>
                </div>
            </div>
            
            {% if reminder.description %}
            <div class="card-description">
                <p>{{ reminder.description }}</p>
            </div>
            {% endif %}
        </div>
        {% endfor %}
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">‚è∞</div>
            <p class="empty-state-text">–£ –≤–∞—Å –Ω–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π</p>
            <button onclick="showModal('createReminderModal')" class="button button-primary">
                –î–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
            </button>
        </div>
        {% endif %}
        {% endif %}
    </div>
</div>

<!-- Create Task Modal -->
<div id="createTaskModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <h2 class="modal-title">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</h2>
        
        <form id="createTaskForm" class="form" method="post" action="/api/tasks">
            <input type="hidden" name="client_id" value="{{ user_id }}">
            
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</label>
                <input type="text" required class="form-input" name="title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–∞–∑–≥—Ä—É–∑–∫–∞ –º–µ–±–µ–ª–∏">
            </div>

            <div class="form-group">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea required class="form-textarea" name="description" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">–¢–∏–ø –∑–∞–¥–∞–Ω–∏—è</label>
                <select class="form-select" name="task_type">
                    <option value="loading">–ü–æ–≥—Ä—É–∑–∫–∞/—Ä–∞–∑–≥—Ä—É–∑–∫–∞</option>
                    <option value="moving">–ü–µ—Ä–µ–µ–∑–¥</option>
                    <option value="cleaning">–£–±–æ—Ä–∫–∞</option>
                    <option value="delivery">–î–æ—Å—Ç–∞–≤–∫–∞</option>
                    <option value="assembly">–°–±–æ—Ä–∫–∞/—Ä–∞–∑–±–æ—Ä–∫–∞</option>
                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">–ê–¥—Ä–µ—Å</label>
                <input type="text" required class="form-input" name="location" placeholder="–ê–¥—Ä–µ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç">
            </div>

            <div class="form-group">
                <label class="form-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</label>
                <input type="datetime-local" required class="form-input" name="start_datetime">
            </div>

            <div class="form-group">
                <label class="form-label">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—á–∞—Å—ã)</label>
                <select class="form-select" name="duration_hours">
                    {% for hour in range(4, 25) %}
                    <option value="{{ hour }}" {% if hour == 8 %}selected{% endif %}>{{ hour }} —á–∞—Å–æ–≤</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">–ë—é–¥–∂–µ—Ç (‚ÇΩ)</label>
                <input type="number" required min="100" class="form-input" name="client_price" placeholder="–°—É–º–º–∞ –∑–∞ –≤—Å–µ –∑–∞–¥–∞–Ω–∏–µ">
            </div>

            <div class="form-actions">
                <button type="button" onclick="hideModal('createTaskModal')" class="button button-secondary">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button type="submit" class="button button-primary">
                    –°–æ–∑–¥–∞—Ç—å
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Create Reminder Modal -->
<div id="createReminderModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <h2 class="modal-title">–°–æ–∑–¥–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</h2>
        
        <form id="createReminderForm" class="form" method="post" action="/api/reminders">
            <input type="hidden" name="user_id" value="{{ user_id }}">
            
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" required class="form-input" name="title" placeholder="–û —á–µ–º –Ω–∞–ø–æ–º–Ω–∏—Ç—å?">
            </div>

            <div class="form-group">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea class="form-textarea" name="description" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label>
                <input type="datetime-local" required class="form-input" name="remind_at">
            </div>

            <div class="form-actions">
                <button type="button" onclick="hideModal('createReminderModal')" class="button button-secondary">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button type="submit" class="button button-primary">
                    –°–æ–∑–¥–∞—Ç—å
                </button>
            </div>
        </form>
    </div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
// Telegram WebApp setup
if (window.Telegram?.WebApp) {
    const webApp = window.Telegram.WebApp;
    webApp.ready();
    webApp.expand();
    
    // Set main button based on active tab
    const activeTab = '{{ active_tab }}';
    if (activeTab === 'tasks') {
        webApp.MainButton.setText('–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ');
        webApp.MainButton.show();
        webApp.MainButton.onClick(() => showModal('createTaskModal'));
    } else if (activeTab === 'reminders') {
        webApp.MainButton.setText('–î–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ');
        webApp.MainButton.show();
        webApp.MainButton.onClick(() => showModal('createReminderModal'));
    }
}

// Form submission handling
document.getElementById('createTaskForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = serializeForm(this);
    formData.client_price = parseFloat(formData.client_price);
    formData.duration_hours = parseInt(formData.duration_hours);
    formData.requirements = [{ worker_type: 'loader', count: 1 }];
    
    try {
        await api.post('/tasks', formData);
        hideModal('createTaskModal');
        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.showAlert('–ó–∞–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é!');
        } else {
            showSuccess('–ó–∞–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é!');
        }
        setTimeout(() => location.reload(), 1000);
    } catch (error) {
        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è');
        } else {
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è: ' + error.message);
        }
    }
});

document.getElementById('createReminderForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = serializeForm(this);
    
    try {
        await api.post('/reminders', formData);
        hideModal('createReminderModal');
        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.showAlert('–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!');
        } else {
            showSuccess('–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!');
        }
        setTimeout(() => location.reload(), 1000);
    } catch (error) {
        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è');
        } else {
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: ' + error.message);
        }
    }
});
</script>
{% endblock %}